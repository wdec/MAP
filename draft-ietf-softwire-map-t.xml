<?xml version="1.0" encoding="US-ASCII"?>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY rfc2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY rfc3633 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3633.xml">
<!ENTITY rfc3056 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3056.xml">
<!ENTITY rfc1933 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.1933.xml">
<!ENTITY rfc5969 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5969.xml">
<!ENTITY rfc2529 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2529.xml">
<!ENTITY rfc5214 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5214.xml">
<!ENTITY rfc4380 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4380.xml">
<!ENTITY rfc2766 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2766.xml">
<!ENTITY rfc6052 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6052.xml">
<!ENTITY rfc6146 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6146.xml">
<!ENTITY rfc6147 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6147.xml">
<!ENTITY rfc6333 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6333.xml">
<!ENTITY rfc6346 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6346.xml">
<!ENTITY rfc6269 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6269.xml">
<!ENTITY rfc6250 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6250.xml">
<!ENTITY rfc2663 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2663.xml">
<!ENTITY rfc6145 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6145.xml">
<!ENTITY rfc0792 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.0792.xml">
<!ENTITY rfc4443 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4443.xml">
<!ENTITY rfc0897 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.0897.xml">
<!ENTITY rfc6324 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6324.xml">
<!ENTITY rfc2827 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2827.xml">
<!ENTITY rfc4632 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4632.xml">
<!ENTITY rfc4862 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4862.xml">
<!ENTITY rfc4953 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4953.xml">
<!ENTITY rfc5961 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5961.xml">
<!ENTITY rfc6056 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6056.xml">
<!ENTITY rfc6219 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6219.xml">
<!ENTITY rfc4787 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4787.xml">
<!ENTITY rfc5508 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5508.xml">
<!ENTITY rfc5382 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5382.xml">
<!ENTITY rfc2473 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2473.xml">
<!ENTITY rfc5383 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5383.xml">
<!ENTITY rfc6877 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6877.xml">
<!ENTITY I-D.ietf-softwire-map-dhcp SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-softwire-map-dhcp.xml">
<!ENTITY I-D.ietf-softwire-stateless-4v6-motivation SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-softwire-stateless-4v6-motivation.xml">
<!ENTITY I-D.ietf-softwire-map SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-softwire-map.xml">
<!ENTITY I-D.ietf-tsvwg-iana-ports SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-tsvwg-iana-ports.xml">
<!ENTITY I-D.xli-behave-divi SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.xli-behave-divi.xml">
<!ENTITY I-D.murakami-softwire-4v6-translation SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.murakami-softwire-4v6-translation.xml">
<!ENTITY I-D.dec-stateless-4v6 SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.dec-stateless-4v6.xml">
<!ENTITY I-D.maglione-softwire-map-t-scenarios SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.maglione-softwire-map-t-scenarios.xml">
]>
<?rfc toc="yes" ?>
<?rfc tocompact="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc comments="yes" ?>
<?rfc inline="yes" ?>
<rfc category="exp" docName="draft-ietf-softwire-map-t-03" ipr="trust200902">
  <front>
    <title abbrev="MAP-T">Mapping of Address and Port using Translation
    (MAP-T)</title>

    <author fullname="Xing Li" initials="X" surname="Li">
      <organization abbrev="">CERNET Center/Tsinghua University</organization>

      <address>
        <postal>
          <street>Room 225, Main Building, Tsinghua University</street>

          <city>Beijing 100084</city>

          <country>CN</country>
        </postal>

        <email>xing@cernet.edu.cn</email>
      </address>
    </author>

    <author fullname="Congxiao Bao" initials="C" surname="Bao">
      <organization abbrev="">CERNET Center/Tsinghua University</organization>

      <address>
        <postal>
          <street>Room 225, Main Building, Tsinghua University</street>

          <city>Beijing 100084</city>

          <country>CN</country>
        </postal>

        <email>congxiao@cernet.edu.cn</email>
      </address>
    </author>

    <author fullname="Wojciech Dec" initials="W" role="editor" surname="Dec">
      <organization>Cisco Systems</organization>

      <address>
        <postal>
          <street>Haarlerbergpark Haarlerbergweg 13-19</street>

          <city>Amsterdam, NOORD-HOLLAND</city>

          <code>1101 CH</code>

          <country>Netherlands</country>
        </postal>

        <phone></phone>

        <email>wdec@cisco.com</email>
      </address>
    </author>

    <author fullname="Ole Troan" initials="O" surname="Troan">
      <organization>Cisco Systems</organization>

      <address>
        <postal>
          <street></street>

          <city>Oslo</city>

          <country>Norway</country>
        </postal>

        <email>ot@cisco.com</email>
      </address>
    </author>

    <author fullname="Satoru Matsushima" initials="S" surname="Matsushima">
      <organization abbrev="">SoftBank Telecom</organization>

      <address>
        <postal>
          <street>1-9-1 Higashi-Shinbashi, Munato-ku</street>

          <city>Tokyo</city>

          <country>Japan</country>
        </postal>

        <email>satoru.matsushima@tm.softbank.co.jp</email>
      </address>
    </author>

    <author fullname="Tetsuya Murakami" initials="T" surname="Murakami">
      <organization abbrev="">IP Infusion</organization>

      <address>
        <postal>
          <street>1188 East Arques Avenue</street>

          <city>Sunnyvale</city>

          <country>USA</country>
        </postal>

        <email>tetsuya@ipinfusion.com</email>
      </address>
    </author>

    <date year="2013" />

    <area>Internet</area>

    <workgroup>Network Working Group</workgroup>

    <!--  SECTION 0:  Abstract                      -->

    <abstract>
      <t>This document specifies the &ldquo;Mapping of Address and Port&rdquo;
      double stateless NAT64 translation based solution (MAP-T) for providing
      shared or uniquely addressed IPv4 device connectivity to and across an
      IPv6 domain.</t>
    </abstract>
  </front>

  <middle>
    <!--  SECTION 1:  Introduction                  -->

    <section title="Introduction">
      <!--
-->

      <t>Experiences from IPv6 deployments in service provider networks such
      as <xref target="RFC6219"> </xref> indicate that a successful transition
      to IPv6 can happen while allowing for continued support of IPv4 users,
      without incurring the burden of an end-end dual stack network. Due to
      IPv4 address exhaustion, this requires technology that supports shared
      IPv4 address usage across an IPv6 network domain, while allowing the
      network operator to realize operational practices and deploy network
      equipment that are ideally the same for both IPv6 or IPv4 end-users. The
      use of double NAT64 translation based solutions is an optimal way to
      address these requirements, especially in combination with stateless
      translation techniques that seek to minimize operational challenges
      outlined in <xref
      target="I-D.ietf-softwire-stateless-4v6-motivation"></xref>.</t>

      <t>The Mapping of Address and Port - Translation (MAP-T) solution
      specified in this document is a double NAT64 based solution, that builds
      on existing stateless NAT64 techniques specified in <xref
      target="RFC6145"></xref>, along with a stateless algorithmic address
      &amp; transport layer port mapping scheme, to allow the sharing of IPv4
      addresses across an IPv6 network. The MAP-T solution is closely related
      to MAP-E <xref target="I-D.ietf-softwire-map"></xref>, with both
      utilizing the same address and port mapping &amp; indexing method, but
      differing in their choice of IPv6 domain transport, i.e. Translation
      <xref target="RFC6145"></xref> for MAP-T and encapsulation <xref
      target="RFC2473"></xref> for MAP-E. The translation mode is deemed
      valuable for environments where the encapsulation overhead, or IPv6
      oriented practices (e.g. use of IPv6 only servers, or IPv6 traffic
      classification) requirements, contribute to an encapsulation based
      solution being not feasable. These scenarios are presented in <xref
      target="I-D.maglione-softwire-map-t-scenarios"></xref></t>

      <t>A companion document, applicable to both MAP-T and MAP-E, defines the
      DHCPv6 options for MAP provisioning <xref
      target="I-D.ietf-softwire-map-dhcp"></xref>.</t>
    </section>

    <!--          -->

    <section anchor="conventions" title="Conventions">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in RFC 2119 <xref
      target="RFC2119"></xref>.</t>
    </section>

    <!---->

    <section title="Terminology">
      <t><list hangIndent="24" style="hanging">
          <t hangText="MAP domain:">One or more MAP CEs and BRs connected by
          means of an IPv6 network and sharing a common set of MAP Rules. A
          service provider may deploy a single MAP domain, or may utilize
          multiple MAP domains.</t>

          <t hangText="MAP Rule:">A set of parameters describing the mapping
          between an IPv4 prefix, IPv4 address or shared IPv4 address and an
          IPv6 prefix or address. Each MAP domain uses a different mapping
          rule set.</t>

          <t hangText="MAP Rule set:">A Rule set is composed out of all the
          MAP Rules communicated to a device, that are intended for
          determining the devices' traffic forwarding operations. A set has at
          least one entry, known as a default map rule. The Rule set is
          interchangeably referred to in this document as a Rule table.</t>

          <t hangText="MAP Rule table:">See MAP Rule set.</t>

          <t hangText="MAP node:">A device that implements MAP.</t>

          <t hangText="MAP Border Relay (BR):">A MAP enabled router managed by
          the service provider at the edge of a MAP domain. A Border Relay
          router has at least an IPv6-enabled interface and an IPv4 interface
          connected to the native IPv4 network. A MAP BR may also be referred
          to simply as a "BR" within the context of MAP.</t>

          <t hangText="MAP Customer Edge (CE):">A device functioning as a
          Customer Edge router in a MAP deployment. A typical MAP CE adopting
          MAP rules will serve a residential site with one WAN side interface,
          and one or more LAN side interfaces. A MAP CE may also be referred
          to simply as a "CE" within the context of MAP.</t>

          <t hangText="Port-set:">Each node has a separate part of the
          transport layer port space; denoted as a port-set.</t>

          <t hangText="Port-set ID (PSID):">Algorithmically identifies a set
          of ports exclusively assigned to the CE.</t>

          <t hangText="Shared IPv4 address:">An IPv4 address that is shared
          among multiple CEs. Only ports that belong to the assigned port-set
          can be used for communication. Also known as a Port-Restricted IPv4
          address.</t>

          <t hangText="End-user IPv6 prefix:">The IPv6 prefix assigned to an
          End-user CE by other means than MAP itself. E.g. Provisioned using
          DHCPv6 PD <xref target="RFC3633"></xref>, assigned via SLAAC <xref
          target="RFC4862"></xref>, or configured manually. It is unique for
          each CE.</t>

          <t hangText="MAP IPv6 address:">The IPv6 address used to reach the
          MAP function of a CE from other CEs and from BRs.</t>

          <t hangText="Rule IPv6 prefix:">An IPv6 prefix assigned by a Service
          Provider for a MAP rule.</t>

          <t hangText="Rule IPv4 prefix:">An IPv4 prefix assigned by a Service
          Provider for a MAP rule.</t>

          <t hangText="Embedded Address (EA) bits:">The IPv4 EA-bits in the
          IPv6 address identify an IPv4 prefix/address (or part thereof) or a
          shared IPv4 address (or part thereof) and a port-set identifier.</t>
        </list></t>
    </section>

    <!--                    -->

    <section title="Architecture">
      <t>Figure 1 depicts the overall MAP-T architecture, which sees any
      number of IPv4 users (N and M used as examples), connected by means of
      MAP-T CEs to an IPv6 network that is equipped with one or more MAP-T BR.
      The CEs and BRs form the MAP-T Domain, by means of configuration that
      they share.</t>

      <t>Functionally the MAP-T CE and BR utilize and extend some well
      established technical building blocks to allow the IPv4 users to
      correspond with nodes on the Public IPv4 network, or IPv6 network as
      follows:</t>

      <t><list style="symbols">
          <t>A regular (NAT44) NAPT <xref target="RFC2663"></xref> function on
          a MAP CE is extended with support for restricting the allowable
          TCP/UDP ports for a given IPv4 address. The IPv4 address and port
          range used are determined by the MAP provisioning process and
          identical to MAP-E <xref target="I-D.ietf-softwire-map"></xref>.</t>

          <t>A standard stateless NAT64 function <xref target="RFC6145">
          </xref> is extended to allow stateless mapping of IPv4 and transport
          layer port ranges to IPv6 address space. This algorithmic mapping is
          specified in section 5.</t>
        </list></t>

      <t><figure align="center" anchor="arch" title="MAP-T Architecture">
          <preamble></preamble>

          <artwork align="center"><![CDATA[      User N
    Private IPv4
   |  Network
   |
O--+---------------O
|  | MAP-T CE      |
| +-----+--------+ |
| NAPT44|  MAP-T | |
| +-----+      | |  -._   ,-------.                     .------.
|       +--------+ |   ,-'         `-.                ,-'       `-.
O------------------O  /              \   O---------O /   Public   \
                      /   IPv6 only   \  |  MAP-T  |/     IPv4     \
                     (    Network      --+  Border +-   Network     )
                      \               /  |  Relay  |\              /
O------------------O  \              /   O---------O \             /
|    MAP-T CE      |   ;".         ,-'                `-.       ,-'
| +-----+--------+ | ,"   `----+--'                      ------'
| NAPT44|  MAP-T | |,          |
| +-----+        | |        IPv6 node(s)
|   |   +--------+ |         (w/ v4 mapped
O---.--------------O          address)
    |
      User M
    Private IPv4
      Network
        ]]></artwork>
        </figure></t>

      <t>Each MAP-T CE is configured by means of MAP procedures with an IPv4
      address and a port-range that is indexed by means of a Port Set
      Identifier (PSID). Each CE is responsible for translating between a
      given users' private IPv4 address space and the CE's MAP derived IPv4
      address + port set, as well as adapting traffic between IPv4 and IPv6
      using NAT64 procedures that are in accordance with the MAP Rules
      applicable for a given domain. The MAP procedures can operate with CE's
      using a shared IPv4 address, full IPv4 addresses or IPv4 prefixes, and
      place no assumption on the IPv6 addressing, other than an IPv6 prefix of
      adequate size being allocated.</t>

      <t>The MAP-T BR is responsible for connecting one or more MAP-T domains
      to external IPv4 networks, using stateless NAT64 as extended by the MAP
      rules in this document, to relay traffic between the two.</t>

      <t>The intended role for NAT64 technology in the architecture is two
      fold. Firstly, it is intended to allow the IPv6 network to focus on IPv6
      operational procedures with minimal consideration of IPv4-only nodes
      attached to the domain. Secondly, it is intended to allow IPv4-only
      nodes to correspond directly with IPv6-only nodes, provided they have an
      IPv4 mapped IPv6 address belonging to the IPv6 prefix assigned to the
      MAP-T domain (as per <xref target="RFC6052"></xref>).</t>

      <t>The detailed operation of the above mechanism is governed by means of
      MAP Rules and an address+port mapping algorithm covered in <xref
      target="mapping-rules"></xref>. <xref target="forwarding"></xref>
      describes how the mechanism is used for packet forwarding
      operations.</t>
    </section>

    <section anchor="mapping-rules" title="Mapping Rules">
      <t>A MAP node is provisioned with one or more mapping rules that govern
      the IPv4 address and port-set are to a node in the IPv6 domain, as well
      specific or default path forwarding behavior for the domain. Three
      specific types of mapping rules are defined:</t>

      <t><list style="numbers">
          <t>Basic Mapping Rule (BMR) - used for determining the CE's IPv4
          address and/or port set, as well as determining the MAP IPv6 address
          that the CE is to use. For a given end-user IPv6 prefix there can be
          only one BMR. The BMR is defined out of the following
          parameters:<list style="symbols">
              <t>Rule IPv6 prefix (including prefix length)</t>

              <t>Rule IPv4 prefix (including prefix length)</t>

              <t>Rule EA-bits length (in bits)</t>

              <t>Optional Rule Port Parameters</t>
            </list></t>

          <t>Forwarding Mapping Rule (FMR) - used for setting up forwarding
          between CEs in the MAP domain (a.k.a. Mesh mode). Each Forwarding
          Mapping Rule will result in a forwarding entry for the Rule IPv4
          prefix + the given port range, i.e. Specific IPv4 + port routes.The
          FMR consists of the following parameters, which are shared with the
          BMR: <list style="symbols">
              <t>Rule IPv6 prefix (including prefix length)</t>

              <t>Rule IPv4 prefix (including prefix length)</t>

              <t>Rule EA-bits length (in bits)</t>

              <t>Optional Rule Port Parameters</t>
            </list></t>

          <t>Default Mapping Rule (DMR) - used for mapping and forwarding to
          destinations outside the MAP domain, i.e. a default route for the
          MAP domain leading to the MAP BR. It consists of:<list
              style="symbols">
              <t>The IPv6 prefix (including prefix length) used to represent
              destinations outside the MAP domain. Typically a routed prefix
              to one or more BRs.</t>
            </list></t>

          <t>Optional Rule Port Parameters - used to represent additional
          configuration settings. Currently defined parameters are<list
              style="symbols">
              <t>Offset: Specifies the numeric value for the MAP algorithm's
              excluded port range/offset bits (A-bits). Unless explicitly
              defined this value MUST default to 6.</t>
            </list></t>
        </list></t>

      <t>By default, every MAP node belonging to a MAP domain node, MUST be
      provisioned with a Basic Mapping Rule (BMR). The rule is then used for
      IPv4 prefix, address or shared address assignment.</t>

      <t>A MAP IPv6 address is formed from the BMR Rule IPv6 prefix. This
      address MUST be assigned to an interface of the MAP node and is used to
      terminate all MAP traffic being sent or received to the node.</t>

      <t>Port-aware IPv4 entries in the Rules table are installed for all the
      Forwarding Mapping Rules and a default route to the MAP BR as per the
      DMR (see section Section 5.3). A given domain can have only one DMR,
      however be deployed for load balancing using multiple BRs, for example
      by means of anycast addressing of the BRs.</t>

      <t>Forwarding rules are used to allow direct communication between MAP
      CEs, known as mesh mode. In hub and spoke mode, there are no forwarding
      rules, and all traffic is forwarded from the CE to the BR by means of
      the DMR.</t>

      <t>The following subsections specify the MAP algorithm and its use of
      Rules.</t>

      <section anchor="bmr" title="Basic mapping rule (BMR)">
        <t>The Basic Mapping Rule is used to derive a CE's IPv4 prefix, IPv4
        address and any associated port-set-id, which are related to the MAP
        domain represented by an IPv6 prefix. Recall from Section 5 that the
        BMR consists of the following parameters:</t>

        <t><list style="symbols">
            <t>Rule IPv6 prefix, of a length n.</t>

            <t>Rule IPv4 prefix, of a length r.</t>

            <t>Rule EA-bits of length o.</t>

            <t>Optional Rule Port Parameters (a, k)</t>
          </list></t>

        <t><xref target="addressalloc-3"></xref> shows the structure of the
        complete MAP IPv6 address of a CE as specified in this document, and
        its relation to the information contained in the BMR and End-user IP6
        prefix. The MAP CE IPv6 address is determined by concatenating the
        End-user IPv6 prefix with the MAP subnet-id (if the End-user IPv6
        prefix is shorter than 64 bits) and the MAP interface ID. The MAP
        interface-id is derived as specified in <xref
        target="interface-id"></xref>. The MAP subnet ID is defined to be the
        first subnet (all bits set to zero). For End-user IPv6 prefixes longer
        than 64 bits, no MAP subnet id is used.</t>

        <t><figure align="center" anchor="addressalloc-3"
            title="IPv6 address format">
            <preamble></preamble>

            <artwork align="center"><![CDATA[


|     n bits         |  o bits   | s bits  |   128-n-o-s bits      |
+--------------------+-----------+---------+------------+----------+
|  Rule IPv6 prefix  |  EA bits  |subnet ID|     interface ID      |
+--------------------+-----------+---------+-----------------------+
|<---  End-user IPv6 prefix  --->|

]]></artwork>
          </figure></t>

        <t>The MAP CE's IPv4 address is determined by completing the r-bits of
        the Rule IPv4 prefix with the remaining IPv4 suffix 32-r bits of
        information (p), along with the optional k bits of the Port Set
        Identifier (PSID). These remaining p + k bits of information
        themselves come from the (o) Embedded-Address (EA) bits of the
        end-user IPv6 prefix. The End-user IPv6 prefix is the IPv6 prefix
        assigned to the CE and is unique per CE.</t>

        <t>The n bit Rule IPv6 prefix, is the part of the End-user IPv6 prefix
        that is common among all CEs using the same Basic Mapping Rule within
        the MAP domain. Similarly, the Rule IPv4 prefix of length r is the
        IPv4 prefix common among all CEs using the same BMR within the MAP
        domain. An EA-bit length of 0 signifies that all relevant p and k bits
        of addressing information are passed directly in the BMR, and not
        derived from the EA bits of the End-user IPv6 prefix. Examples of
        these and other cases are given in <xref
        target="appendix_a"></xref>.</t>

        <t>For a given BMR, if o + r &lt; 32 (length of the IPv4 address in
        bits), then an IPv4 prefix is being intended for use by the BMR. This
        case is shown in <xref target="addressallocation4-fig"></xref>.</t>

        <t><figure align="center" anchor="addressallocation4-fig"
            title="IPv4 prefix">
            <preamble></preamble>

            <artwork align="center"><![CDATA[

|   r bits    |     32-r bits       |
+-------------+---------------------+
|  Rule IPv4  | IPv4 Address suffix |
+-------------+---------------------+
|           < 32 bits               |
]]></artwork>
          </figure></t>

        <t>If o + r is equal to 32, then a full IPv4 address is to be
        assigned. The address is created by concatenating the Rule IPv4 prefix
        and the EA-bits. This case is shown in <xref
        target="addressallocation5-fig"></xref>.</t>

        <t><figure align="center" anchor="addressallocation5-fig"
            title="Complete IPv4 address">
            <preamble></preamble>

            <artwork align="center"><![CDATA[

|   r bits    |     32-r bits       |        
+-------------+---------------------+         
|  Rule IPv4  | IPv4 Address suffix |        
+-------------+---------------------+        
|            32 bits                |

]]></artwork>
          </figure>If o + r is &gt; 32, then a shared IPv4 address is to be
        assigned, and is the case shown in <xref
        target="addressallocation6"></xref>. The number of IPv4 address suffix
        bits (p) in the EA bits is given by 32 - r. The PSID bits are used to
        create a port-set. The length of the PSID bit field within EA bits is:
        k = o - 32 + r.</t>

        <t><figure align="center" anchor="addressallocation6"
            title="Shared IPv4 address">
            <preamble></preamble>

            <artwork align="center"><![CDATA[

|   r bits    |     32-r bits       |         |   k bits   |
+-------------+---------------------+         +------------+
|  Rule IPv4  | IPv4 Address suffix |         |Port-Set ID |
+-------------+---------------------+         +------------+
|            32 bits                |

]]></artwork>
          </figure></t>

        <t>It should be noted that the length r MAY be zero, in which case the
        complete IPv4 address or prefix is encoded in the EA bits. Similarly
        the length of o MAY, in which case no part of the CE's IPv6 end-user
        prefix is used to derive the CE's IPv4 address. To create a complete
        IPv4 address (or prefix), the IPv4 address suffix (p = 32-r) from the
        EA bits, is concatenated with the Rule IPv4 prefix (r bits).</t>

        <t>The BMR is provisioned to the CE by means (e.g. a DHCPv6 option)
        not specified in this document.</t>

        <t>See <xref target="appendix_a"></xref> for an example of the Basic
        Mapping Rule.</t>
      </section>

      <section anchor="fmr" title="Forwarding mapping rule (FMR)">
        <t>The Forwarding Mapping Rule is an optional rule used in mesh mode
        to enable direct CE to CE connectivity.</t>

        <t>The processing of an FMR rule results in a route entry being
        installed on the processing MAP device for the IPv4 Rule prefix and
        any associated port range. The "next hop" of such a route is the MAP
        transformation defined by the rule's key elements:</t>

        <t><list style="symbols">
            <t>The Rule IPv6 prefix, of a length n.</t>

            <t>The Rule IPv4 prefix, of a length r.</t>

            <t>The Rule EA-bits of length o.</t>

            <t>Optional Rule Port Parameters (a, k)</t>
          </list></t>

        <t>On forwarding an IPv4 packet, a best matching prefix look up is
        done and the closest matching FMR is chosen. The IPv6 destination
        address is derived from the destination IPv4 + port in combination
        with the rule's parameters as exemplified in <xref
        target="aplusptoipv6-fig"></xref>.</t>

        <t><figure align="left" anchor="aplusptoipv6-fig"
            title="Deriving of MAP IPv6 address">
            <preamble></preamble>

            <artwork align="left"><![CDATA[

|        32 bits           |         |    16 bits        |
+--------------------------+         +-------------------+
| IPv4 destination address |         |  IPv4 dest port   |
+--------------------------+         +-------------------+
                :          :           ___/       :
|    r bits     |32-r bits |          /  k bits   :
+---------------+----------+         +------------+ 
|   Rule IPv4   |IPv4  sufx|         |Port-Set ID |
+---------------+----------+         +------------+
                \          /    ____/    ________/
                  \       :  __/   _____/                 
                    \     : /     /
|     n bits         |  o bits   | s bits  |   128-n-o-s bits      |
+--------------------+-----------+---------+------------+----------+
|  Rule IPv6 prefix  |  EA bits  |subnet ID|     interface ID      |
+--------------------+-----------+---------+-----------------------+
|<---  End-user IPv6 prefix  --->|

]]></artwork>
          </figure></t>

        <t>See <xref target="appendix_a"></xref> for an example of the
        Forwarding Mapping Rule.</t>
      </section>

      <section title="Port mapping algorithm">
        <t>The port mapping algorithm is used in domains whose MAP Rules
        allows IPv4 address sharing, and is intended to allow the a range of
        ports to be represented by an algorithmically computable index, the
        Port Set Identifier (PSID) that is unique for each CE.</t>

        <t>The simplest way to represent a port range is using a notation
        similar to CIDR <xref target="RFC4632"></xref>. For example the first
        256 ports are represented as port prefix 0.0/8. The last 256 ports as
        255.0/8. In hexadecimal, 0x0000/8 (PSID = 0) and 0xFF00/8 (PSID =
        0xFF). Using this technique, but wishing to avoid allocating the
        system ports <xref target="I-D.ietf-tsvwg-iana-ports"></xref> to a
        give CE, one would have to exclude the use of one or more PSIDs (e.g.,
        PSIDs 0 to 3 in the example just given).</t>

        <t>As will be seen shortly, the PSID forms a portion of the End-user
        IPv6 prefix, however it is desirable to minimize the dependencies
        between the End-user IPv6 prefix and the assigned port set. This is
        achieved by using an infix representation of the port value. Using
        such a representation, the well-known ports are excluded by
        restrictions on the value of the first A high-order bits of the
        transport port space, known as the A-bit field, rather than the PSID
        itself, whihc directly follows. For a given A-bit field value, and a
        given PSID, the range of contiguous ports being represented are all
        the combinations of the remaining m wildcard bits (i.e. 2^m
        combinations) out of the 16-bit field, as shown in the figure
        below.</t>

        <t><figure align="left" anchor="psid-fig" title="PSID">
            <preamble></preamble>

            <artwork align="left"><![CDATA[
                     0                   1
                     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6
                     +-------+-----------+-----------+ 
       Ports in      |   A   |    PSID   |     M     |
    the CE port set  |  > 0  |           | any value | 
                     +-------+-----------+-----------+ 
                     |a bits |  k bits   |  m bits   |
     ]]></artwork>
          </figure></t>

        <t><list style="hanging">
            <t hangText="A">Selects the range of the port number. For a &gt;
            0, A MUST be larger than 0. This ensures that the algorithm
            excludes the system ports. For this value of a, the system ports,
            but no others, are excluded by requiring that A be greater than 0.
            For smaller values of a, A still has to be greater than 0, but
            this excludes ports above 1023. For larger values of a, the
            minimum value of A has to be higher to exclude all the system
            ports. The interval between successive contiguous ranges assigned
            to the same user is 2^a.</t>

            <t hangText="a-bits">The number of offset bits. The default Offset
            bits (a) are: 6. To simplify the port mapping algorithm the
            defaults are chosen so that the PSID field starts on a nibble
            boundary and the excluded port range (0-1023) is extended to
            0-4095.</t>

            <t hangText="PSID">The Port Set Identifier. Different Port-Set
            Identifiers (PSID) MUST have non-overlapping port-sets.</t>

            <t hangText="k-bits">The length in bits of the PSID field. The
            sharing ratio is k^2. The number of ports assigned to the user is
            2^(16-k) - 2^m (excluded ports)</t>

            <t hangText="M">Selects the specific port within the particular
            range specified by the concatenation of A and the PSID.</t>

            <t hangText="m bits">The contiguous port size, i.e. the number of
            contiguous ports allocated to a given PSID. The number of
            contiguous ports is given by 2^m.</t>
          </list></t>
      </section>

      <section anchor="dmr" title="Default mapping rule (DMR)">
        <t>IPv4 traffic between MAP-T nodes that are all within one MAP domain
        is translated to IPv6, with the senders MAP IPv6 address as the IPv6
        source address and the receiving MAP node's MAP IPv6 address as the
        IPv6 destination address. To reach destinations outside the MAP-T
        domain and/or for the case when the MAP domain is defined to be
        composed out of a single CE and BR, the Default Mapping rule is used.
        The DMR is specified in terms of the BR IPv6 prefix that MAP-T CEs
        will use for mapping an IPv4 destination address.</t>

        <t><figure title="Example: Default Mapping Rule">
            <artwork align="left"><![CDATA[
 Default Mapping Rule:     
      {2001:db8:0001::/Prefix-length (Rule IPv6 prefix),
       0.0.0.0/0 (Rule IPv4 prefix)}
       ]]></artwork>
          </figure></t>

        <t>It is recommended that the BR prefix-length SHOULD be by default 64
        bits long, and in any case MUST NOT exceed 96 bits. The mapping of the
        IPv4 destination behind the IPv6 prefix will by default follow the /64
        rule as per <xref target="RFC6052"></xref>. Any trailing bits after
        the IPv4 address are set to 0x0.</t>
      </section>

      <section anchor="interface-id" title="The IPv6 Interface Identifier">
        <t>The Interface identifier format of a MAP node is described
        below.</t>

        <t><figure align="left" anchor="interfaceid2-fig" title="">
            <preamble></preamble>

            <artwork align="left"><![CDATA[

|        128-n-o-s bits            |
| 16 bits|    32 bits     | 16 bits|
+--------+----------------+--------+
|   0    |  IPv4 address  |  PSID  |
+--------+----------------+--------+
 
]]></artwork>
          </figure></t>

        <t>In the case of an IPv4 prefix, the IPv4 address field is
        right-padded with zeros up to 32 bits. The k-bit PSID is zero
        left-padded to create a 16 bit field. For an IPv4 prefix or a complete
        IPv4 address, the PSID field is zero.</t>

        <t>If the End-user IPv6 prefix length is larger than 64, the most
        significant parts of the interface identifier is overwritten by the
        prefix.</t>
      </section>
    </section>

    <section title="MAP-T Configuration">
      <t>For a given MAP domain, the BR and CE MUST be configured with the
      following MAP elements. The configured values for these elements are
      identical for all CEs and BRs within a given MAP domain.</t>

      <t><list style="symbols">
          <t>The Basic Mapping Rule and optionally the Forwarding Mapping
          Rules, including the Rule IPv6 prefix, Rule IPv4 prefix, and Length
          of EA bits</t>

          <t>Hub and spoke mode or Mesh mode. (If all traffic should be sent
          to the BR, or if direct CE to CE traffic should be supported).</t>

          <t>Use of Translation mode (MAP-T)</t>

          <t>The BR's IPv6 prefix used in the DMR</t>
        </list>The MAP-T CE and BR configuration is the same as for MAP-E
      described in Section 7 of <xref target="I-D.ietf-softwire-map"></xref>
      except for two differences:</t>

      <t><list style="symbols">
          <t>Translation mode is used instead of Encapsulation</t>

          <t>Use of the BR's IPv6 prefix instead of address</t>
        </list></t>

      <section title="MAP CE">
        <t>The MAP elements are set to values that are the same across all CEs
        within a MAP domain. The values may be configured in a variety of
        manners, including provisioning methods such as the Broadband Forum's
        "TR-69" Residential Gateway management interface, an XML-based object
        retrieved after IPv6 connectivity is established, DHCPv6, or manual
        configuration by an administrator. This document does not prescribe
        any of these methods, but recommends that a MAP CE SHOULD implement
        DHCPv6 options as per <xref
        target="I-D.ietf-softwire-map-dhcp"></xref>. Other configuration and
        management methods may use the format described by this option for
        consistency and convenience of implementation on CEs that support
        multiple configuration methods.</t>

        <t>The only remaining provisioning information the CE requires in
        order to calculate the MAP IPv4 address and enable IPv4 connectivity
        is the IPv6 prefix for the CE. The End-user IPv6 prefix is configured
        as part of obtaining IPv6 Internet access, and requires no special
        handling.</t>

        <t>The MAP provisioning parameters, and hence the IPv4 service itself,
        is tied to the End-user IPv6 prefix; thus, the MAP service is also
        tied to this in terms of authorization, accounting, etc. The MAP IPv4
        address, prefix or shared IPv4 address and port set has the same
        lifetime as its associated End-user IPv6 prefix.</t>

        <t>A single MAP CE MAY be connected to more than one MAP domain, just
        as any router may have more than one IPv4-enabled service provider
        facing interface and more than one set of associated addresses
        assigned by DHCPv6. Each domain a given CE operates within would
        require its own set of MAP configuration elements and would generate
        its own IPv4 address. The MAP DHCPv6 option is specified in <xref
        target="I-D.ietf-softwire-map-dhcp"></xref></t>
      </section>

      <section title="MAP BR">
        <t>The MAP BR MUST be configured with the same MAP elements as the MAP
        CEs operating within the same domain.</t>

        <t>For increased reliability and load balancing, the BR IPv6 prefix
        MAY be shared across a given MAP domain. As MAP is stateless, any BR
        may be used at any time.</t>

        <t>Since MAP uses provider address space, no specific routes need to
        be advertised externally for MAP to operate, neither in IPv6 nor IPv4
        BGP. However, the BR prefix needs to be advertised in the service
        provider's IGP.</t>
      </section>
    </section>

    <section anchor="forwarding" title="MAP-T Packet Forwarding">
      <t>The end-end packet flow in MAP-T involves an IPv4 or IPv6 packet
      being forwarded across one or both of a CE and a BR, in one of two
      directions in for each such case.</t>

      <section title="IPv4 to IPv6 at the CE">
        <t>A MAP-T CE receiving IPv4 packets SHOULD perform NAPT NAT44
        function, and create any necessary NAPT44 bindings. The source address
        and port of the packet obtained as a result of the NAPT44 process MUST
        correspond to the source IPv4 address and source transport port number
        derived to belong to the CE by means of the MAP Basic Mapping Rule
        (BMR).</t>

        <t>The resulting IPv4 packet is subject to a longest IPv4 address +
        port match MAP rule selection, which then determines the parameters
        for the subsequent NAT64 operation. By default, all traffic is matched
        to the default mapping rule (DMR), and subject to the stateless NAT64
        operation using the DMR parameters for the MAP algorithm and NAT64.
        Packets matching destinations covered by any (optional) forward
        mapping rules (FMRs) are subject to the stateless NAT64 operation
        using the FMR parameters for the MAP algorithm and stateless
        NAT64.</t>

        <t>A MAP-T CE MUST support a default mapping rule and SHOULD support
        one or more forward mapping rules.</t>
      </section>

      <section title="IPv6 to IPv4 at the CE">
        <t>A MAP-T CE receiving an IPv6 packet performs its regular IPv6
        operations (filtering, pre-routing, etc). Only packets that are
        addressed to the CE's MAP-T addresses, and with source addresses
        matching the IPv6 map-rule prefixes of a DMR or FMR, are processed by
        the MAP-T CE. All other IPv6 traffic SHOULD be forwarded as per the
        CE&rsquo;s IPv6 routing rules. The CE SHOULD check that MAP-T received
        packets' destination transport-layer destination port number is in the
        range allowed for by the CE's MAP BMR configuration. The CE SHOULD
        drop any non conforming packet and respond with an ICMPv6 "Address
        Unreachable" (Type 1, Code 3). For packets whose source address
        matches an FMR, the CE SHOULD perform a check of consistency of the
        source against the allowed values from the source port-range. If the
        packets' source port number is found to be outside the range allowed,
        the CE MUST drop the packet and SHOULD respond with an ICMPv6
        "Destination Unreachable, Source address failed ingress/egress policy"
        (Type 1, Code 5).</t>

        <t>For each MAP-T processed packet, the CE's NAT64 function MUST
        derive the IPv4 source and destination addresses. The IPv4 destination
        address is derived by extracting relevant information from the IPv6
        destination and the information stored in the BMR as per <xref
        target="bmr"></xref> of this document. The IPv4 source address is
        formed by classifying the packet's source as matching a DMR or FMR
        rule prefix, and then using that NAT64 rule-set, as per <xref
        target="dmr"></xref> or <xref target="fmr"></xref> respectively.</t>

        <t>The resulting IPv4 packet is then forwarded to the CE&rsquo;s NAPT
        NAT44 function, where the destination IPv4 address and port number
        MUST be mapped to their original value, before being forwarded
        according to the CE's regular IPv4 rules. When the NAPT function is
        not enabled, the traffic from the stateless NAT64 function is directly
        forwarded according to the CE's IPv4 rules.</t>
      </section>

      <section title="IPv6 to IPv4 at the BR">
        <t>A MAP-T BR receiving IPv6 packets MUST select a matching MAP rule
        based on a longest address match of the packets' source address
        against the BR&rsquo;s configured MAP Rules. In combination with the
        port-set-id contained in the packet's source IPv6 address, the
        selected MAP rule allows the BR to verify that the CE is using its
        allowed address and port range. Thus, the BR MUST perform a validation
        of the consistency of the source against the allowed values from the
        identified port-range. If the packets' source port number is found to
        be outside the range allowed, the BR MUST drop the packet and respond
        with an ICMPv6 "Destination Unreachable, Source address failed
        ingress/egress policy" (Type 1, Code 5).</t>

        <t>When constructing the IPv4 packet, the BR MUST derive the source
        and destination IPv4 addresses as per Section 5 of this document and
        translate the IPv6 to IPv4 headers as per <xref
        target="RFC6145"></xref>. The resulting IPv4 packets are then passed
        to regular IPv4 forwarding.</t>
      </section>

      <section title="IPv4 to IPv6 at the BR">
        <t>A MAP-T BR receiving IPv4 packets uses a longest match IPv4 +
        transport layer port lookup to identify the target MAP-T domain and
        rule. The MAP-T BR MUST then compute the IPv6 destination addresses
        from the IPv4 destination address and port as per <xref
        target="bmr"></xref> of this document. The MAP-T BR MUST also compute
        the IPv6 source addresses from the IPv4 source address as per <xref
        target="dmr"></xref> (i.e. It needs to form an IPv6 mapped IPv4
        address using the BR's DMR prefix). Throughout the generic IPv4 to
        IPv6 header procedures following <xref target="RFC6145"></xref> apply.
        The resulting IPv6 packets are then passed to regular IPv6
        forwarding.</t>

        <t>Note that the operation of a BR when forwarding to MAP-T domains
        that are defined without IPv4 address sharing is the same as stateless
        NAT64 IPv4/IPv6 translation.</t>
      </section>
    </section>

    <section title="ICMP Handling">
      <t>ICMP messages supported in the MAP-T domain need to take into
      consideration also the NAPT44 component and best current practice
      documented in <xref target="RFC5508"></xref> along with some additional
      specific considerations.</t>

      <t>MAP-T CEs and BRs MUST follow ICMP/ICMPv6 translation as per <xref
      target="RFC6145"></xref>, with the following extension to cover the
      address sharing/port-range feature.</t>

      <t>Unlike TCP and UDP, which provide two transport protocol port fields
      to represent both source and destination, the ICMP/ICMPv6 <xref
      target="RFC0792"></xref>, <xref target="RFC4443"></xref> Query message
      header has only one ID field which needs to be used to identify a
      sending IPv4 host.</t>

      <t>When receiving IPv4 ICMP messages, the MAP-T CE MUST rewrite the ID
      field to a port value derived from the CE's Port-set-id.</t>

      <t>In the return path, when MAP-T BR receives an IPv4 ICMP packet
      containing an ID field which is bound for a shared address in the MAP-T
      domain, the MAP-T BR SHOULD use the ID value as a substitute for the
      destination port in determining the IPv6 destination address. In all
      other cases, the MAP-T BR MUST derive the destination IPv6 address by
      simply mapping the destination IPv4 address without additional port
      info. Throughout the ICMP message MUST be translated as per [RFC6145]
      with the the ID field preserved.</t>
    </section>

    <section title="Fragmentation and Path MTU Discovery">
      <t>Due to the different sizes of the IPv4 and IPv6 header, handling the
      maximum packet size is relevant for the operation of any system
      connecting the two address families. There are three mechanisms to
      handle this issue: Path MTU discovery (PMTUD), fragmentation, and
      transport-layer negotiation such as the TCP Maximum Segment Size (MSS)
      option <xref target="RFC0897"></xref>. MAP uses all three mechanisms to
      deal with different cases.</t>

      <section title="Fragmentation in the MAP domain">
        <t>Translating an IPv4 packet to carry it across the MAP domain will
        increase its size by 20 bytes respectively. It is strongly recommended
        that the MTU in the MAP domain is well managed and that the IPv6 MTU
        on the CE WAN side interface is set so that no fragmentation occurs
        within the boundary of the MAP domain.</t>

        <t>Fragmentation in MAP-T domain is to be handled as described in
        section 4 and 5 of <xref target="RFC6145"></xref>.</t>
      </section>

      <section title="Receiving IPv4 Fragments on the MAP domain borders">
        <t>Forwarding of an IPv4 packet received from the outside of the MAP
        domain requires the IPv4 destination address and the transport
        protocol destination port. The transport protocol information is only
        available in the first fragment received. As described in section
        5.3.3 of <xref target="RFC6346"></xref> a MAP node receiving an IPv4
        fragmented packet from outside has to reassemble the packet before
        sending the packet onto the MAP link. If the first packet received
        contains the transport protocol information, it is possible to
        optimize this behavior by using a cache and forwarding the fragments
        unchanged. A description of this algorithm is outside the scope of
        this document.</t>
      </section>

      <section title="Sending IPv4 fragments to the outside">
        <t>If two IPv4 host behind two different MAP CE's with the same IPv4
        address sends fragments to an IPv4 destination host outside the
        domain. Those hosts may use the same IPv4 fragmentation identifier,
        resulting in incorrect reassembly of the fragments at the destination
        host. Given that the IPv4 fragmentation identifier is a 16 bit field,
        it could be used similarly to port ranges. A MAP CE SHOULD rewrite the
        IPv4 fragmentation identifier to be within its allocated port set.</t>
      </section>
    </section>

    <section title="Usage Considerations">
      <section title="EA-bit length of 0">
        <t>The MAP solution supports use and configuration of domains with a
        BMR expressing an EA-bit length of 0. This results in independence
        between the end-user IPv6 prefix assigned to the CE and the IPv4
        address and/or port-range used by MAP. The k-bits of PSID information
        may in this case be derived from the BMR.</t>

        <t>The constraint imposed is that each such MAP domain be composed of
        just 1 MAP CE which has a predetermined IPv6 prefix. The BR would be
        configured with an FRM rule per CPE, where the FMR would uniquely
        describe the IPv6 prefix of a given CE. Each CE would have a distinct
        BMR, that would fully describe that CE's IPv4 address, and PSID if
        any.</t>

        <!--   -->
      </section>

      <section title="Mesh and Hub and spoke modes">
        <t>The hub and spoke mode of communication, whereby all traffic sent
        by a MAP-T CE is forwarded via a BR, and the mesh mode, whereby a CE
        is directly able to forward traffic to another CE, are governed by the
        activation of Forward Mapping Rule that cover the IPv4-prefix
        destination, and port-index range. By default, a MAP CE configured
        only with a BMR, as per this specification, will use it to configure
        its IPv4 parameters and IPv6 MAP address without enabling mesh
        mode.</t>
      </section>

      <section title="Communication with IPv6 servers in the MAP-T domain">
        <t>By default, MAP-T allows communication between both IPv4-only and
        any IPv6 enabled devices, as well as with native IPv6-only servers
        provided that the servers are configured with an IPv4-mapped IPv6
        address. This address could be part of the the IPv6 prefix used by the
        DMR in the MAP-T domain. Such IPv6 servers (e.g. an HTTP server, or a
        web content cache device) are thus able to serve both IPv6 users as
        well as IPv4-only users users alike utilizing IPv6. Any such IPv6-only
        servers SHOULD have both A and AAAA records in DNS. DNS64 <xref
        target="RFC6147"></xref> become required only when IPv6 servers in the
        MAP-T domain are expected themselves to initiate communication to
        external IPv4-only hosts.</t>
      </section>

      <section title="Compatibility with other NAT64 solutions">
        <t>A MAP-T CE is by default compatible with <xref
        target="RFC6146"></xref> stateful NAT64 devices that are placed to
        use/advertise the BR prefix. This in effect allows the use of MAP-T
        CEs in environments that need to perform statistical multiplexing of
        IPv4 addresses, while utilizing stateful NAT64 devices, and can take
        the role of a CLAT as defined in <xref target="RFC6877"></xref>.</t>

        <t>Furthermore, a MAP-T CE configured to operate without address
        sharing (no PSID) is compatible with any stateless NAT64 devices
        positioned as BRs.</t>
      </section>
    </section>

    <!--  SECTION 4:  IANA Considerations           -->

    <section title="IANA Considerations">
      <t>This specification does not require any IANA actions.</t>
    </section>

    <!--  SECTION 5:  Security Considerations      	-->

    <section title="Security Considerations">
      <t><list style="hanging">
          <t hangText="Spoofing attacks:">With consistency checks between IPv4
          and IPv6 sources that are performed on IPv4/IPv6 packets received by
          MAP nodes, MAP does not introduce any new opportunity for spoofing
          attacks that would not already exist in IPv6.</t>

          <t hangText="Denial-of-service attacks:">In MAP domains where IPv4
          addresses are shared, the fact that IPv4 datagram reassembly may be
          necessary introduces an opportunity for DOS attacks. This is
          inherent to address sharing, and is common with other address
          sharing approaches such as DS-Lite and NAT64/DNS64. The best
          protection against such attacks is to accelerate IPv6 enablement in
          both clients and servers so that, where MAP is supported, it is less
          and less used.</t>

          <t hangText="Routing-loop attacks:">This attack may exist in some
          automatic tunneling scenarios are documented in <xref
          target="RFC6324"></xref>. They cannot exist with MAP because each
          BRs checks that the IPv6 source address of a received IPv6 packet is
          a CE address based on Forwarding Mapping Rule.</t>

          <t
          hangText="Attacks facilitated by restricted port           set:">From
          hosts that are not subject to ingress filtering of <xref
          target="RFC2827"></xref>, some attacks are possible by an attacker
          injecting spoofed packets during ongoing transport connections
          (<xref target="RFC4953"></xref>, <xref target="RFC5961"></xref>,
          <xref target="RFC6056"></xref>. The attacks depend on guessing which
          ports are currently used by target hosts, and using an unrestricted
          port set is preferable, i.e. Using native IPv6 connections that are
          not subject to MAP port range restrictions. To minimize this type of
          attacks when using a restricted port set, the MAP CE's NAT44
          filtering behavior SHOULD be "Address-Dependent Filtering".
          Furthermore, the MAP CEs SHOULD use a DNS transport proxy function
          to handle DNS traffic, and source such traffic from IPv6 interfaces
          not assigned to MAP-T. Practicalities of these methods are discussed
          in Section 5.9 of <xref target="I-D.dec-stateless-4v6"></xref>.</t>

          <t hangText="ICMP Flood">Given the necessity to process and
          translate ICMP and ICMPv6 messages by the BR and CE nodes, a
          foreseeable attack vector is that of a flood of such messages
          leading to a saturation of the nodes' compute resources. This attack
          vector is not specific to MAP, and its mitigation lies a combination
          of policing the rate of ICMP messages, policing the rate at which
          such messages can get processed by the MAP nodes, and of course
          identifying and blocking off the source(s) of such traffic.</t>
        </list></t>

      <t><xref target="RFC6269"></xref> outlines general issues with IPv4
      address sharing.</t>
    </section>

    <!--  SECTION 6:  Contributors     			-->

    <section title="Contributors">
      <t>The following individuals authored major contribution to this
      document:</t>

      <t>Chongfeng Xie (China Telecom) Room 708, No.118, Xizhimennei Street
      Beijing 100035 CN Phone: +86-10-58552116 Email: xiechf@ctbri.com.cn</t>

      <t>Qiong Sun (China Telecom) Room 708, No.118, Xizhimennei Street
      Beijing 100035 CN Phone: +86-10-58552936 Email:
      sunqiong@ctbri.com.cn</t>

      <t>Rajiv Asati (Cisco Systems) 7025-6 Kit Creek Road Research Triangle
      Park NC 27709 USA Email: rajiva@cisco.com</t>

      <t>Gang Chen (China Mobile) 53A,Xibianmennei Ave. Beijing 100053
      P.R.China Email: chengang@chinamobile.com</t>

      <t>Wentao Shang (CERNET Center/Tsinghua University) Room 225, Main
      Building, Tsinghua University Beijing 100084 CN Email:
      wentaoshang@gmail.com</t>

      <t>Guoliang Han (CERNET Center/Tsinghua University) Room 225, Main
      Building, Tsinghua University Beijing 100084 CN Email:
      bupthgl@gmail.com</t>

      <t>Yu Zhai CERNET Center/Tsinghua University Room 225, Main Building,
      Tsinghua University Beijing 100084 CN Email: jacky.zhai@gmail.com</t>
    </section>

    <!---->

    <section title="Acknowledgements">
      <t>This document is based on the ideas of many. In particular Remi
      Despres, who has tirelessly worked on generalized mechanisms for
      stateless address mapping.</t>

      <t>The authors would like to thank Mohamed Boucadair, Guillaume Gottard,
      Dan Wing, Jan Zorz, Necj Scoberne, Tina Tsou, , Gang Chen, Maoke Chen,
      Xiaohong Deng, Jouni Korhonen, Tomasz Mrugalski, Jacni Qin, Chunfa Sun,
      Qiong Sun, Leaf Yeh, Andrew Yourtchenko for their review and
      comments.</t>
    </section>
  </middle>

  <back>
    <!--  SECTION 8.1:  Normative References		-->

    <references title="Normative References">
      &rfc2119;

      &rfc6052;

      &rfc6145;

      &rfc6346;
    </references>

    <!--  SECTION 8.2:  Informative References		-->

    <references title="Informative References">
      &rfc0792;

      &rfc0897;

      &rfc2473;

      &rfc2663;

      &rfc2827;

      &rfc3633;

      &rfc4443;

      &rfc4632;

      &rfc4862;

      &rfc4953;

      &rfc5508;

      &rfc5961;

      &rfc6056;

      &rfc6146;

      &rfc6147;

      &rfc6324;

      &rfc6219;

      &rfc6269;

      &rfc6877;

      &I-D.dec-stateless-4v6;

      &I-D.ietf-softwire-stateless-4v6-motivation;

      &I-D.ietf-softwire-map;

      &I-D.ietf-softwire-map-dhcp;

      &I-D.ietf-tsvwg-iana-ports;

      &I-D.xli-behave-divi;

      &I-D.maglione-softwire-map-t-scenarios;
    </references>

    <section anchor="appendix_a" title="Examples of MAP-T translation">
      <t><figure>
          <preamble>Example 1 - Basic Mapping Rule:</preamble>

          <artwork align="left"><![CDATA[

   Given the following MAP domain information and IPv6 end-user 
   prefix assigned to a MAP CE:

   IPv6 prefix assigned to the end-user:  2001:db8:0012:3400::/56
   Basic Mapping Rule:  {2001:db8:0000::/40 (Rule IPv6 prefix),
      192.0.2.0/24 (Rule IPv4 prefix), 16 (Rule EA-bits length)}
   PSID length: (16 - (32 - 24) = 8. (Sharing ratio of 256)
   PSID offset:  6 (default)

   A MAP node (CE or BR) can via the BMR, or equivalent FMR, 
   determine the IPv4 address and port-set as shown below:

   EA bits offset:  40
   IPv4 suffix bits (p)  Length of IPv4 address (32) - IPv4 prefix
      length (24) = 8
   IPv4 address  192.0.2.18 (0xc0000212)
   PSID start:  40 + p = 40 + 8 = 48
   PSID length (q):  o - p = (End-user prefix len - 
      rule IPv6 prefix len) - p = (56 - 40) - 8 = 8
   PSID:  0x34

   Available ports (63 ranges) : 1232-1235, 2256-2259, ...... ,
                                    63696-63699, 64720-64723

   The BMR information allows a MAP CE to determine (complete)
   its IPv6 address within the indicated end-user IPv6 prefix.

   IPv6 address of MAP CE:  2001:db8:0012:3400:0000:c000:0212:0034

  ]]></artwork>
        </figure></t>

      <t><figure>
          <preamble>Example 2 - BR:</preamble>

          <artwork align="left"><![CDATA[

   Another example can be made of a hypothetical MAP-T BR,
   configured with the following FMR when receiving a packet
   with the following characteristics:

   IPv4 source address:  1.2.3.4 (0x01020304)
   TCP source port:  80
   IPv4 destination address:  192.0.2.18 (0xc0000212)
   TCP destination port:  1232

   Configured Forwarding Mapping Rule:  {2001:db8::/40
      (Rule IPv6 prefix), 192.0.2.0/24 (Rule IPv4 prefix),
      16 (Rule EA-bits length)}

   MAP-T BR Prefix (DMR)  2001:db8:ffff::/64

   The above information allows the BR to derive as follows
   the mapped destination IPv6 address for the corresponding
   MAP-T CE, and also the source IPv6 address for
   the mapped IPv4 source address.

   IPv4 suffix bits (p)  32 - 24 = 8 (18 (0x12))
   PSID length:  8
   PSID:  0x34 (1232)

   The resulting IPv6 packet will have the following header fields:

   IPv6 source address  2001:db8:ffff:0:0001:0203:0400::
   IPv6 destination address:  2001:db8:0012:3400:0000:c000:0212:0034
   TCP source Port:  80
   TCP destination Port:  1232

  ]]></artwork>
        </figure></t>

      <t><figure>
          <preamble>Example 3- FMR:</preamble>

          <artwork align="left"><![CDATA[
   
   An IPv4 host behind a MAP-T CE (configured as per the previous
   examples) corresponding with an IPv4 host 1.2.3.4 will have its
   packets converted into IPv6 using the DMR configured on the MAP-T
   CE as follows:

   Default Mapping Rule used by MAP-T CE:  {2001:db8:ffff::/64
   (Rule IPv6 prefix), 0.0.0.0/0 (Rule IPv4 prefix), null (BR IPv4
      address)}

   IPv4 source address (post NAT44 if present)  192.0.2.18
   IPv4 destination address:  1.2.3.4
   IPv4 source port (post NAT44 if present):  1232
   IPv4 destination port:  80
   IPv6 source address of MAP-T CE:
                        2001:db8:0012:3400:0000:c000:0212:0034
   IPv6 destination address:  2001:db8:ffff:0:0001:0203:0400::
   
  ]]></artwork>
        </figure><figure>
          <preamble>Example 4 - Rule with no embedded address bits and no
          address sharing</preamble>

          <artwork><![CDATA[
   End-user IPv6 prefix:  2001:db8:0012:3400::/56
   Basic Mapping Rule:  {2001:db8:0012:3400::/56 (Rule IPv6 prefix),
      192.0.2.1/32 (Rule IPv4 prefix), 0 (Rule EA-bits length)}
   PSID length: 0 (Sharing ratio is 1)
   PSID offset:  n/a

   A MAP node can via the BMR or equivalent FMR, determine
   the IPv4 address and port-set as shown below:

   EA bits offset:  0
   IPv4 suffix bits (p)  Length of IPv4 address - IPv4 prefix
      length = 32 - 32 = 0
   IPv4 address  192.0.2.1 (0xc0000201)
   PSID start:  0
   PSID length: 0
   PSID:  null

   The BMR information allows a MAP CE also to determine (complete)
   its full IPv6 address by combining the IPv6 prefix with the MAP
   interface identifier (that embeds the IPv4 address).

   IPv6 address of MAP CE:  2001:db8:0012:3400:0000:c000:0201:0000

]]></artwork>
        </figure><figure>
          <preamble>Example 5 - Rule with no embedded address bits and address
          sharing (sharing ratio 256)</preamble>

          <artwork><![CDATA[
   End-user IPv6 prefix:  2001:db8:0012:3400::/56
   Basic Mapping Rule:  {2001:db8:0012:3400::/56 (Rule IPv6 prefix),
      192.0.2.1/32 (Rule IPv4 prefix), 0 (Rule EA-bits length)}
   PSID length: (16 - (32 - 24)) = 8. (Provisioned with DHCPv6. 
                Sharing ratio of 256.).
   PSID offset:  6 (default)
   PSID: 0x20 (Provisioned with DHCPv6)

   A MAP node can via the BMR determine the IPv4 address and port-set 
   as shown below:

   EA bits offset:  0
   IPv4 suffix bits (p):  Length of IPv4 address - IPv4 prefix
      length = 32 -32 = 0
   IPv4 address  192.0.2.1 (0xc0000201)
   PSID start:  0
   PSID length: 8
   PSID:  0x20

   Available ports (63 ranges) : 1536-1551, 2560-2575, ...... ,
                                    64000-64015, 65024-65039

   The BMR information allows a MAP CE also to determine (complete)
   its full IPv6 address by combining the IPv6 prefix with the MAP
   interface identifier (that embeds the IPv4 address and PSID).

   IPv6 address of MAP CE:  2001:db8:0012:3400:0000:c000:0212:0034

   Note that the IPv4 address and PSID is not derived from the IPv6
   prefix assigned to the CE, but provisioned separately using for 
   example MAP options in DHCPv6.

]]></artwork>
        </figure></t>
    </section>

    <section title="Port mapping algorithm">
      <t>The driving principles and the mathematical expression of the mapping
      algorithm used by MAP can be found in Appendix B of <xref
      target="I-D.ietf-softwire-map"></xref></t>

      <t></t>
    </section>
  </back>
</rfc>
